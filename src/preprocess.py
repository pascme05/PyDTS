#######################################################################################################################
#######################################################################################################################
# Title:        PyDTS (Python Deep Timeseries Simulation)
# Topic:        Black-Box Modeling
# File:         start
# Date:         03.11.2023
# Author:       Dr. Pascal A. Schirmer
# Version:      V.0.1
# Copyright:    Pascal Schirmer
#######################################################################################################################
#######################################################################################################################

#######################################################################################################################
# Import libs
#######################################################################################################################
# ==============================================================================
# Internal
# ==============================================================================
from src.data.resampleData import resampleData
from src.data.normData import normData
from src.data.filterData import filterData
from src.general.helpFnc import addNoise
from src.general.addInitValues import addInitValues

# ==============================================================================
# External
# ==============================================================================
import numpy as np


#######################################################################################################################
# Function
#######################################################################################################################
def preprocess(data, setupDat, setupPar):
    ###################################################################################################################
    # MSG IN
    ###################################################################################################################
    print("INFO: Preprocessing Data (X,y)")

    ###################################################################################################################
    # Calculation
    ###################################################################################################################
    # ==============================================================================
    # Resampling
    # ==============================================================================
    [data['X'], timeX] = resampleData(data['X'], setupDat['fs_raw_X'], setupDat)
    [data['y'], timeY] = resampleData(data['y'], setupDat['fs_raw_y'], setupDat)

    # ==============================================================================
    # Removing Values
    # ==============================================================================
    idX = data['X']['id']
    idY = data['y']['id']
    data['X'] = data['X'].drop(['time', 'id'], axis=1)
    data['y'] = data['y'].drop(['time', 'id'], axis=1)

    # ==============================================================================
    # Initial values
    # ==============================================================================
    if setupPar['init'] == 1:
        data['X'] = addInitValues(data['X'], data['y'], idX, setupDat)

    # ==============================================================================
    # Introducing Time Lag
    # ==============================================================================
    if setupPar['solver'] != 'CL':
        for names in data['y']:
            data['y'][names] = np.roll(data['y'][names], setupPar['lag'])

    # ==============================================================================
    # Filtering
    # ==============================================================================
    # ------------------------------------------
    # Input
    # ------------------------------------------
    if setupDat['inpFil'] != 0:
        data['X'] = filterData(data['X'], setupDat['inpFil'], setupDat['inpFilLen'])

    # ------------------------------------------
    # Output
    # ------------------------------------------
    if setupDat['outFil'] != 0:
        data['y'] = filterData(data['y'], setupDat['outFil'], setupDat['outFilLen'])

    # ==============================================================================
    # Adding Noise
    # ==============================================================================
    # ------------------------------------------
    # Input
    # ------------------------------------------
    if setupDat['inpNoise'] != 0:
        data['X'] = addNoise(data['X'], setupDat['inpNoise'])

    # ------------------------------------------
    # Output
    # ------------------------------------------
    if setupDat['outNoise'] != 0:
        data['y'] = addNoise(data['y'], setupDat['outNoise'])

    # ==============================================================================
    # Normalizing
    # ==============================================================================
    [data['X'], data['y']] = normData(data['X'], data['y'], setupDat, 0)

    ###################################################################################################################
    # Post-processing
    ###################################################################################################################
    # ==============================================================================
    # Sanity Check
    # ==============================================================================
    timeX = timeX[0:min(timeX.shape[0], timeY.shape[0])]
    timeY = timeX[0:min(timeX.shape[0], timeY.shape[0])]
    idX = idX[0:min(idX.shape[0], idY.shape[0])]
    idY = idX[0:min(idX.shape[0], idY.shape[0])]
    data['X'] = data['X'][0:min(data['y'].shape[0], data['X'].shape[0])]
    data['y'] = data['y'][0:min(data['y'].shape[0], data['X'].shape[0])]

    # ==============================================================================
    # Reset Index
    # ==============================================================================
    data['X'] = data['X'].reset_index(drop=True)
    data['y'] = data['y'].reset_index(drop=True)

    ###################################################################################################################
    # Return
    ###################################################################################################################
    return [data, timeY, idY]
