#######################################################################################################################
#######################################################################################################################
# Title:        PyDTS (Python Deep Timeseries Simulation)
# Topic:        Black-Box Modeling
# File:         testMdlCL
# Date:         03.11.2023
# Author:       Dr. Pascal A. Schirmer
# Version:      V.0.1
# Copyright:    Pascal Schirmer
#######################################################################################################################
#######################################################################################################################


#######################################################################################################################
# Import libs
#######################################################################################################################
# ==============================================================================
# Internal
# ==============================================================================
from src.general.helpFnc import reshapeMdlData
from src.model.models import tfMdlCNN, tfMdlDNN, tfMdlLSTM

# ==============================================================================
# External
# ==============================================================================
import os
import tensorflow as tf
import time
from sys import getsizeof
import numpy as np
import copy


#######################################################################################################################
# Function
#######################################################################################################################
def testMdlCL(data, setupDat, setupPar, setupMdl, setupExp):
    ###################################################################################################################
    # MSG IN
    ###################################################################################################################
    print("INFO: Test Model (CL)")

    ###################################################################################################################
    # Initialisation
    ###################################################################################################################
    # ==============================================================================
    # CPU/GPU
    # ==============================================================================
    if setupExp['gpu'] == 1:
        os.environ['CUDA_VISIBLE_DEVICES'] = '0'
        physical_devices = tf.config.list_physical_devices('GPU')
        tf.config.experimental.set_memory_growth(physical_devices[0], True)
    else:
        os.environ['CUDA_VISIBLE_DEVICES'] = '-1'
        tf.config.set_visible_devices([], 'GPU')

    # ==============================================================================
    # Variables
    # ==============================================================================
    mdl = []
    dataTest = copy.deepcopy(data)
    dataPred = {'T': {'X': {}, 'y': np.zeros(np.size(data['T']['y']))}}
    dataShift = {}
    dataShift['T'] = copy.deepcopy(data['T']['y'])

    # ==============================================================================
    # Name
    # ==============================================================================
    mdlName = 'mdl/mdl_' + setupPar['model'] + '_' + setupExp['name'] + '/cp.ckpt'

    ###################################################################################################################
    # Pre-Processing
    ###################################################################################################################
    # ==============================================================================
    # Introduce Lag
    # ==============================================================================
    dataShift['T'] = np.roll(dataTest['T']['y'], setupPar['lag'])

    # ==============================================================================
    # Combine Data
    # ==============================================================================
    dataShift['T'] = dataShift['T'].reshape(dataShift['T'].shape[0], 1) * np.ones((dataShift['T'].shape[0], data['T']['X'].shape[1]))
    dataTest['T']['X'] = np.concatenate((dataTest['T']['X'], dataShift['T'][:, :, np.newaxis]), axis=2)

    # ==============================================================================
    # Reshape Data
    # ==============================================================================
    [dataTest['T']['X'], dataTest['T']['y']] = reshapeMdlData(dataTest['T']['X'], dataTest['T']['y'], setupDat, setupPar, 0)

    # ==============================================================================
    # Model Input and Output
    # ==============================================================================
    if len(setupDat['out']) == 1:
        if setupPar['outseq'] >= 1:
            out = dataTest['T']['y'].shape[1]
        else:
            out = 1
    else:
        out = len(setupDat['out'])

    # ==============================================================================
    # Create Model
    # ==============================================================================
    # ------------------------------------------
    # Init
    # ------------------------------------------
    if setupPar['method'] == 0:
        activation = 'linear'
    else:
        activation = 'sigmoid'

    # ------------------------------------------
    # DNN
    # ------------------------------------------
    if setupPar['model'] == "DNN":
        mdl = tfMdlDNN(dataTest['T']['X'], out, activation)

    # ------------------------------------------
    # CNN
    # ------------------------------------------
    if setupPar['model'] == "CNN":
        mdl = tfMdlCNN(dataTest['T']['X'], out, activation)

    # ------------------------------------------
    # LSTM
    # ------------------------------------------
    if setupPar['model'] == "LSTM":
        mdl = tfMdlLSTM(dataTest['T']['X'], out, activation)
    mdl.summary()

    ###################################################################################################################
    # Loading
    ###################################################################################################################
    try:
        mdl.load_weights(mdlName)
        print("INFO: Model loaded")
    except:
        print("ERROR: Model could not be loaded")

    ###################################################################################################################
    # Calculation
    ###################################################################################################################
    # ==============================================================================
    # Compiling
    # ==============================================================================
    # ------------------------------------------
    # Init
    # ------------------------------------------
    # RMSprop
    if setupMdl['opt'] == 'RMSprop':
        opt = tf.keras.optimizers.RMSprop(learning_rate=setupMdl['lr'], rho=setupMdl['rho'],
                                          momentum=setupMdl['mom'], epsilon=setupMdl['eps'])

    # SGD
    elif setupMdl['opt'] == 'SDG':
        opt = tf.keras.optimizers.SGD(learning_rate=setupMdl['lr'], momentum=setupMdl['mom'])

    # Adam
    else:
        opt = tf.keras.optimizers.Adam(learning_rate=setupMdl['lr'], beta_1=setupMdl['beta1'],
                                       beta_2=setupMdl['beta2'], epsilon=setupMdl['eps'])

    # ------------------------------------------
    # Compile
    # ------------------------------------------
    mdl.compile(optimizer=opt, loss=setupMdl['loss'], metrics=setupMdl['metric'])

    # ==============================================================================
    # Start timer
    # ==============================================================================
    start = time.time()

    # ==============================================================================
    # Test
    # ==============================================================================
    # ------------------------------------------
    # y
    # ------------------------------------------
    for i in range(0, dataTest['T']['X'].shape[0]):
        if i >= abs(setupPar['lag']):
            tempX = dataTest['T']['X'][i, :, :]
            tempX[:, -1] = dataPred['T']['y'][i-abs(setupPar['lag'])] * np.ones(dataTest['T']['X'].shape[1])
        else:
            tempX = dataTest['T']['X'][i, :, :]
        dataPred['T']['y'][i] = mdl.predict(tempX.reshape(1, dataTest['T']['X'].shape[1], dataTest['T']['X'].shape[2]))

    # ------------------------------------------
    # X
    # ------------------------------------------
    dataPred['T']['X'] = dataTest['T']['X'][:, :, :-1]

    # ==============================================================================
    # End timer
    # ==============================================================================
    ende = time.time()
    testTime = (ende - start)

    ###################################################################################################################
    # Post-Processing
    ###################################################################################################################
    print("INFO: Total inference time (ms): %.2f" % (testTime * 1000))
    print("INFO: Inference time per sample (us): %.2f" % (testTime / data['T']['X'].shape[0] * 1000 * 1000))
    print("INFO: Model size (kB): %.2f" % (getsizeof(mdl) / 1024 / 8))

    ###################################################################################################################
    # References
    ###################################################################################################################
    return dataPred
