#######################################################################################################################
#######################################################################################################################
# Title:        PyDTS (Python Deep Timeseries Simulation)
# Topic:        Black-Box Modeling
# File:         train
# Date:         03.11.2023
# Author:       Dr. Pascal A. Schirmer
# Version:      V.0.1
# Copyright:    Pascal Schirmer
#######################################################################################################################
#######################################################################################################################


#######################################################################################################################
# Import libs
#######################################################################################################################
# ==============================================================================
# Internal
# ==============================================================================
from src.preprocess import preprocess
from src.general.framing import framing
from src.general.features import features
from src.general.createSeq import createSeq
from src.model.trainMdlDL import trainMdlDL
from src.model.trainMdlML import trainMdlML
from src.model.trainMdlSP import trainMdlSP
from src.general.adaptDim import adaptDim
from src.data.summaryData import summaryData

# ==============================================================================
# External
# ==============================================================================
import copy


#######################################################################################################################
# Function
#######################################################################################################################
def train(data, setupExp, setupDat, setupPar, setupMdl):
    ###################################################################################################################
    # MSG IN
    ###################################################################################################################
    print("INFO: Running PyDTS (Training)")
    print("\n")

    ###################################################################################################################
    # Initialisation
    ###################################################################################################################
    dataTrain = {'T': {}, 'V': {}}

    ###################################################################################################################
    # Pre-Processing
    ###################################################################################################################
    # ==============================================================================
    # Msg
    # ==============================================================================
    print("------------------------------------------")
    print("START: Preprocessing")
    print("------------------------------------------")

    # ==============================================================================
    # Data Summary
    # ==============================================================================
    summaryData(data['T']['X'], data['T']['y'], setupDat)

    # ==============================================================================
    # Calc
    # ==============================================================================
    [data['T'], t, _] = preprocess(data['T'], copy.deepcopy(setupDat), setupPar)
    [data['V'], _, _] = preprocess(data['V'], setupDat, setupPar)

    # ==============================================================================
    # Msg
    # ==============================================================================
    print("\n")

    ###################################################################################################################
    # Framing
    ###################################################################################################################
    # ==============================================================================
    # Msg
    # ==============================================================================
    print("------------------------------------------")
    print("START: Framing and Edge Detection")
    print("------------------------------------------")

    # ==============================================================================
    # Calc
    # ==============================================================================
    if setupPar['frame'] == 1:
        if setupPar['overlap'] == -1:
            dataTrain['T']['X'] = framing(data['T']['X'], setupPar['window'], 0)
            dataTrain['T']['y'] = framing(data['T']['y'], setupPar['window'], 0)
            dataTrain['V']['X'] = framing(data['V']['X'], setupPar['window'], 0)
            dataTrain['V']['y'] = framing(data['V']['y'], setupPar['window'], 0)
        else:
            dataTrain['T']['X'] = framing(data['T']['X'], setupPar['window'], setupPar['overlap'])
            dataTrain['T']['y'] = framing(data['T']['y'], setupPar['window'], setupPar['overlap'])
            dataTrain['V']['X'] = framing(data['V']['X'], setupPar['window'], setupPar['overlap'])
            dataTrain['V']['y'] = framing(data['V']['y'], setupPar['window'], setupPar['overlap'])
    else:
        dataTrain['T']['X'] = data['T']['X'].values
        dataTrain['T']['y'] = data['T']['y'].values
        dataTrain['V']['X'] = data['V']['X'].values
        dataTrain['V']['y'] = data['V']['y'].values
        print("INFO: No frames calculated using raw data")

    # ==============================================================================
    # Msg
    # ==============================================================================
    print("\n")

    ###################################################################################################################
    # Features
    ###################################################################################################################
    # ==============================================================================
    # Msg
    # ==============================================================================
    print("------------------------------------------")
    print("START: Feature Extraction")
    print("------------------------------------------")

    # ==============================================================================
    # Calc
    # ==============================================================================
    if setupPar['feat'] == 1 or setupPar['feat'] == 3:
        dataTrain['T']['X'] = features(dataTrain['T']['X'], setupMdl['feat'])
        dataTrain['V']['X'] = features(dataTrain['V']['X'], setupMdl['feat'])
    else:
        print("INFO: No features calculated using raw data")

    # ==============================================================================
    # Msg
    # ==============================================================================
    print("\n")

    ###################################################################################################################
    # Sequence
    ###################################################################################################################
    # ==============================================================================
    # Msg
    # ==============================================================================
    print("------------------------------------------")
    print("START: Creating Input Sequence")
    print("------------------------------------------")

    # ==============================================================================
    # Calc
    # ==============================================================================
    if setupPar['frame'] == 1:
        dataTrain['T']['y'] = createSeq(dataTrain['T']['y'], setupPar)
        dataTrain['V']['y'] = createSeq(dataTrain['V']['y'], setupPar)

    # ==============================================================================
    # Adapt Dimension
    # ==============================================================================
    [dataTrain['T']['X'], dataTrain['T']['y'], _] = adaptDim(dataTrain['T']['X'], dataTrain['T']['y'], setupPar)
    [dataTrain['V']['X'], dataTrain['V']['y'], _] = adaptDim(dataTrain['V']['X'], dataTrain['V']['y'], setupPar)

    # ==============================================================================
    # Msg
    # ==============================================================================
    print("\n")

    ###################################################################################################################
    # Training
    ###################################################################################################################
    # ==============================================================================
    # Msg
    # ==============================================================================
    print("------------------------------------------")
    print("START: Training")
    print("------------------------------------------")

    # ==============================================================================
    # Model
    # ==============================================================================
    # ------------------------------------------
    # Classical Learning
    # ------------------------------------------
    if setupPar['solver'] == 'SP':
        trainMdlSP(dataTrain, t, setupPar, setupMdl, setupExp)

    # ------------------------------------------
    # Machine Learning
    # ------------------------------------------
    elif setupPar['solver'] == 'ML':
        trainMdlML(dataTrain, setupPar, setupMdl, setupExp)

    # ------------------------------------------
    # Deep Learning
    # ------------------------------------------
    elif setupPar['solver'] == 'DL':
        trainMdlDL(dataTrain, setupDat, setupPar, setupMdl, setupExp)

    ###################################################################################################################
    # MSG Out
    ###################################################################################################################
    print("DONE: Running PyDTS (Training)")
    print('----------------------')
    print("\n\n")
